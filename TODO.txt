- Transfer resource to other unit to save it.
  [√] add a tranfer resource to citytile procedure when condition matched
     * agent who do transfer:
       1. coal > 0 or uranium > 0
       2. citytile has any unit
       3. fuel > city_fuel_ask + 50
       4. only to the first citytile (ignore other duplicated citytile)
     * only transfer required amout for city to last to game end
  [√] Add Replan city rescue tasks based on city fuel request.
     * cap the amount of resource required by a city and ignore too much resource.
     * Ignore (unit, city) duing replan to select other targets.
  [√] Wait for idle worker to arrive and tranfer
  [√] raise the targeted city tile weight for on citytile idle worker during the
     second round of target assignment
  [-] What if two worker want tranfer? no possible, one would be enough.
  [√] How to send (or stick) non-idle worker into resource receive position.
  [] How to limit the size of city.
    * [√] add score to save small city: save small city at all cost (made of coal or uranium)
    * [] Do not build on non-near resource tile.
- [] citytile around high level resource, will block fuel into large city outside.
  * A: Support transfer for other resource, but not use the resource to build citytile.
  * [√] B: keep one boundary open for coal and uranium cluster


# resource assignment. (resource delivery)
- If multiple worker goto citytile, e.g. 5, but 3 is enough, how to deal with that?
  - another case is, if both of the worker went to city, but city will still die, what should they do?

imagine every city is a hive, and there is a queue.
- cart will deliver the resource to the queen on city (transfer)
- worker focus on resource mining and only transfer the resource to cart
- cart will maintain all the available resource in its cargo, and use left over resource for more city building.


# [Defend Cluster]
- [√] Defend opponent unit with min threaten distance, that is if the opponent unit is
  too close to my cluster, we'll defend it to our best.
- [√] If current cluster is the nearest to enemy, defend that cell.
- [√] Keep at least two near resource tile for a coal or urnaium cluster (open=1)
- [] Use different weight for less than and equal for opponent_weight


# [Cluster Assignment]
- [√] Try weight cluster by boundary opening rate
- [] Remove initial cluster assigment condition check: city > 1
- [] Assign multiple worker to large cluster
  * [] Try split large cluster into multiple ones (limit cluster size), maybe just multiple assignment?
- explore size = 1 wood

# Resource
- [] do not save wood city tile if no enemy around.
- [] Try not build on non near resource tile (except for connection point), limit city size
- Decide upon front which city to save: (resource may not be able to save all cities)
- Should also estimate whether a large city is saveable given the resource on the map.
- Visit resource far away (need to check whether it will across citytile)
  (is it the case that user should not leave citytile when amount > 0? or maybe a fair amount?)
* Limit the number of citytile per cluster
* [minor opt]: do not move to cell has limit resource due to collection: predict cell dying

# Weight
- [] Default city tile (0.000001) weight might be too large, use 0?
- ?? Do not use decay for neighbour resource tile
- How to balance city boost and cluster weight and build_city?

# Build city
- Boost cluster explore task over city build task?
- Is it possible to tranfer and build city on the first day? any use?
- [√] Step out at at last night - 3, to build city tile on first day
- [√] boost weight for neighbour city tile building (encourage citytile cluster)
  * remove build city turn limit, so worker will goto near resource tile natually
- Build city tile on long sides (to connect, side >= 2?)
* [√] Save size 1 citytile
  * with min weight of 1 for city_survive_boost & city_crash_boost

# Build woker
* [?] Do not spawn at night in dying city.

# Tranfer
- [] Try transfer coal and uranium? why we need it? (build city faster)
- Use tranfer to save worker

# Mix
- add randomized actions order
- **Ending pose: build extra city tile with transfer

# Path Search
- Add units (enemy and mine) to cell and check blocking

# Refactor
- [√] remove unused code
- [√] extract a cluster class for query cluster related info (e.g. boundary and type)
- [] Add common function for accessing debug variable
- [] Refactor cell weights into Factors or Rules
==========================



1633768368043_qeFNY225VyVF, 293079651, a0, simple_defend
- [√] t10/u3 staying at coal cell with 100 wood, not moving.
  * it's tracked by the resource weight
  * [-] A) inc threshold build_city_bonus
  * [√] B) use unit info for resource weight
  * >> Think about weight for resource tile and near resource tile.
- [-] u8 t49 moving away from nrt (2, 7) to (3, 7)
  * triggered opponent weight at (3, 7)
- [√] Test add size=1 cluster and drop min city count for cluster assignment.
- [√] Test split different weight for < and == opponent_weight
  * This will help with collision break: to move to other near resource tile that can help.



1633776682734_pYgXffrP3Ogs, 416249851, a1, simple_defend
- [√] t11, u_1 with 40, should not goto resource tile but wait.
  * u_1 wood=40, move to resource and back to build need 5 turns, while wait need only 4
  * for wood >= 2, both move and wait need 5 turns, choose to wait.
- [√] t11, u_2, move to nrt (9, 11), but prefer (9, 8)
  * try to split threaten defend weight and nearest point defend weight
  * [√] Add 501/21 separate for nrt and rt threaten boost.
  * [√] Double threaten dist at night!


opponent_name	Tong_Hui_Kang_v4	defend_agent	lux_perspective	priority_search	simple_defend	tranfer_agent_v1
Tong_Hui_Kang_v4	0.0	1.3	6.1	7.1	10.0	22.9
defend_agent	98.7	0.0	51.5	84.0	70.7	87.8
lux_perspective	93.9	50.0	0.0	81.8	69.6	90.3
priority_search	92.9	16.0	18.2	0.0	42.9	68.8
simple_defend	90.0	29.3	30.4	60.7	0.0	91.2
tranfer_agent_v1	77.1	12.2	9.7	31.2	10.5	0.0

Total Matches: 912 | Matches Queued: 8
Name                           | ID             | Score=(μ - 3σ)  | Mu: μ, Sigma: σ    | Matches
/home/flynnwang/dev/playground/versions/defend_agent/main.py | hYoxE34HXqWM   | 30.5388760      | μ=33.122, σ=0.861  | 350
/home/flynnwang/dev/playground/lux_perspective/main.py | vAB8YTYDyBXy   | 28.6247210      | μ=31.152, σ=0.842  | 342
/home/flynnwang/dev/playground/versions/simple_defend/main.py | E0hz6q0afeQf   | 26.7983082      | μ=29.258, σ=0.820  | 325
/home/flynnwang/dev/playground/versions/priority_search/main.py | RsjhiEoWCyKS   | 24.3931984      | μ=26.889, σ=0.832  | 287
/home/flynnwang/dev/playground/versions/tranfer_agent_v1/main.py | qyD1loqPcDRK   | 21.5729811      | μ=24.166, σ=0.864  | 251
/home/flynnwang/dev/playground/versions/Tong_Hui_Kang_v4/main.py | 4rVKGxPD2P41   | 17.5555168      | μ=20.582, σ=1.009  | 269


(why regression?)


1633907441404_ll5yuRv0Zstu, 115367527, a1, simple
- [√] Test revert threaten boost.
- t4, u2, move back to (7, 8), not (5, 7)


1633905665683_LcRNpDTPNRdt, 66476846, a1, simple
- t5, u2, back and forth (5, 11), (6, 11)
  * conflict between cluster weight and opponent boosting rule.
  * [√] keep open ratio = 1 when unit arrived at cluster
  * [√] lower opponent weight to be smaller than cluster boosting.
  * [√] check cluster has player citytile <= 1 to boost
  * [-]! instead of elemeninating the cluster, how about make it avialbe for all the unit?
    > not OK, then the cluster assignment is not really working
- [√] t100, not saving large city
  * bug? only use small city crash boost and survive boost for sz=1 wood city tile.


1633892893627_2sURrL14kBSC
- t14, u_2, cluster assingment issue
  [√] Bug: should use open_rate of 1 for both boundary and resource positions.


>>>>>>>> evaluating...


[] Add cell level threat weight.

- [] Play with the idea do not collect resource to wood city.
  * t60, u2, resource tile (0, 13), city (0, 12)
  * because of wt+1 for wood full worker goto city rule
  * could work: by use 0 weight for wood city tiles (leave a bug for current version)
- [] not enough worker into the largest resource cluster
  * try multi worker to cluster


IDEAS:
- [] Add cooldown into near_resource_tile discount?
- support wait on days for priority search (for resource research points)? why?

- Learning
* unit cargo won't goto 100 at night
* in city tile, road level is 6 (which means, move to citytile at night is good)
* A full worker will not collect resource
